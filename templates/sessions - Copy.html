<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sessions</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    .layout{display:flex;min-height:100vh;width:100%}
    #sidebar{position:sticky;top:0;height:100vh;flex:0 0 260px;background:#343a40;color:#fff;display:flex;flex-direction:column;gap:10px;padding:16px;overflow:auto}
    #main{flex:1;padding:16px;overflow:auto}
    .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid #ddd;background:#fff;color:#111;padding:10px 12px;border-radius:6px;text-decoration:none;cursor:pointer}
    .title{font-size:18px;font-weight:600;margin:6px 0 10px}
    .list{display:flex;flex-direction:column;gap:6px}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid #ddd;background:#fff;color:#111;padding:10px;border-radius:6px;cursor:pointer}
    .item.active{outline:2px solid #111}
    .row{display:flex;gap:8px;align-items:center}
    .pill{font-size:12px;border:1px solid #ccc;border-radius:12px;padding:2px 8px}
    .messages{display:flex;flex-direction:column;gap:10px}
    .msg{border:1px solid #ddd;background:#fff;padding:10px;border-radius:6px}
    .muted{opacity:.7}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .toolbar{display:flex;gap:8px;margin-bottom:12px}
    .search{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    .small{font-size:12px}
    .nowrap{white-space:nowrap}
    .divider{height:1px;background:#e5e5e5;margin:8px 0}
    .empty{padding:12px}
  </style>
</head>
<body>
  <div class="layout">
    <aside id="sidebar">
      <div class="title">Sessions</div>
      <div class="toolbar">
        <a href="/" class="btn" id="backBtn">Back</a>
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
      <input id="filterInput" class="search" placeholder="Filter…" />
      <div id="sessionsList" class="list" aria-live="polite"></div>
    </aside>

    <main id="main">
      <div class="title">Messages</div>
      <div class="row small muted">
        <span id="activeSessionId" class="mono"></span>
        <span id="activeSessionMeta" class="pill"></span>
      </div>
      <div class="divider"></div>
      <div id="messages" class="messages" aria-live="polite">
        <div class="empty muted">Select a session.</div>
      </div>
    </main>
  </div>

  <script>
    const BASE = window.location.origin;
    const SESSIONS_URL = `${BASE}/logs/sessions`;
    const MESSAGES_URL = `${BASE}/logs/messages`;

    const sessionsListEl = document.getElementById("sessionsList");
    const messagesEl = document.getElementById("messages");
    const activeSessionIdEl = document.getElementById("activeSessionId");
    const activeSessionMetaEl = document.getElementById("activeSessionMeta");
    const filterInputEl = document.getElementById("filterInput");
    const refreshBtn = document.getElementById("refreshBtn");

    let allSessions = [];
    let activeSessionId = null;

    refreshBtn.addEventListener("click", loadSessions);
    filterInputEl.addEventListener("input", renderSessions);

    async function fetchJson(url) {
      const res = await fetch(url, {
        cache: "no-store",
        credentials: "same-origin",
        headers: { "Accept": "application/json" }
      });
      const ct = res.headers.get("content-type") || "";
      if (!ct.includes("application/json")) {
        const t = await res.text();
        throw new Error(`Non-JSON from ${url}\n${t.slice(0,300)}`);
      }
      return res.json();
    }

    async function loadSessions() {
      sessionsListEl.innerHTML = "<div class='empty muted'>Loading…</div>";
      try {
        // Try /logs/sessions
        const s = await fetchJson(SESSIONS_URL).catch(() => null);
        const direct = s ? (Array.isArray(s) ? s : (s.sessions || [])) : [];
        if (direct.length) {
          allSessions = direct;
        } else {
          // Fallback: group /logs/messages by session_id
          const m = await fetchJson(`${MESSAGES_URL}?limit=10000`);
          const msgs = Array.isArray(m) ? m : (m.messages || []);
          const map = new Map();
          for (const x of msgs) {
            const sid = x.session_id || "default";
            if (!map.has(sid)) map.set(sid, []);
            map.get(sid).push(x);
          }
          allSessions = Array.from(map.entries()).map(([sid, arr]) => {
            const last = arr[arr.length - 1] || {};
            const when = String(last.ts || last.timestamp || last.time || "");
            return { id: sid, session_id: sid, title: sid, turns: arr.length, updated_at: when };
          });
          allSessions.sort((a,b) => String(b.updated_at).localeCompare(String(a.updated_at)));
        }
        renderSessions();
        if (!activeSessionId && allSessions.length) {
          selectSession(allSessions[0].session_id || allSessions[0].id);
        }
      } catch (e) {
        sessionsListEl.innerHTML = "<div class='empty muted'>Failed to load sessions.</div>";
        console.error(e);
      }
    }

    function renderSessions() {
      const q = filterInputEl.value.trim().toLowerCase();
      const filtered = allSessions.filter(s => {
        const id = (s.session_id || s.id || "").toLowerCase();
        const title = (s.title || "").toLowerCase();
        return !q || id.includes(q) || title.includes(q);
      });

      if (!filtered.length) {
        sessionsListEl.innerHTML = "<div class='empty muted'>No sessions.</div>";
        return;
      }

      sessionsListEl.innerHTML = "";
      for (const s of filtered) {
        const id = s.session_id || s.id || "";
        const when = s.started_at || s.created_at || s.updated_at || "";
        const title = s.title || id;

        const div = document.createElement("div");
        div.className = "item" + (id === activeSessionId ? " active" : "");
        div.dataset.sessionId = id;
        div.innerHTML = `
          <div class="row">
            <span class="mono small nowrap">${escapeHtml(id.slice(0,8))}</span>
            <span class="pill small">${escapeHtml(String(s.turns ?? s.messages_count ?? "-")+" msgs")}</span>
          </div>
          <div class="small">${escapeHtml(title)}</div>
          <div class="small muted nowrap">${escapeHtml(String(when))}</div>
        `;
        div.addEventListener("click", () => selectSession(id));
        sessionsListEl.appendChild(div);
      }
    }

    async function selectSession(id) {
      activeSessionId = id;
      document.querySelectorAll(".item").forEach(el => {
        el.classList.toggle("active", el.dataset.sessionId === id);
      });
      activeSessionIdEl.textContent = id || "";
      activeSessionMetaEl.textContent = "";
      messagesEl.innerHTML = "<div class='empty muted'>Loading…</div>";

      try {
        // Try server-side filtering
        let data = await fetchJson(`${MESSAGES_URL}?session_id=${encodeURIComponent(id)}&limit=10000`).catch(() => null);
        let msgs = data ? (Array.isArray(data) ? data : (data.messages || [])) : [];

        // If server ignores session_id, filter client-side
        if (msgs.length && !msgs.some(m => (m.session_id || "") === id)) {
          msgs = msgs.filter(m => (m.session_id || "") === id);
        }

        // If empty, fallback to all messages then filter
        if (!msgs.length) {
          const all = await fetchJson(`${MESSAGES_URL}?limit=10000`);
          const allMsgs = Array.isArray(all) ? all : (all.messages || []);
          msgs = allMsgs.filter(m => (m.session_id || "") === id);
        }

        renderMessages(msgs);
      } catch (e) {
        messagesEl.innerHTML = "<div class='empty muted'>Failed to load messages.</div>";
        console.error(e);
      }
    }

    function renderMessages(msgs) {
      if (!msgs.length) {
        messagesEl.innerHTML = "<div class='empty muted'>No messages.</div>";
        activeSessionMetaEl.textContent = "0 msgs";
        return;
      }
      messagesEl.innerHTML = "";
      for (const m of msgs) {
        const ts = m.ts || m.time || m.timestamp || "";
        const role = m.role || m.speaker || "";
        const text = (m.content ?? m.text ?? "");
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `
          <div class="row small muted">
            <span class="mono nowrap">${escapeHtml(String(ts))}</span>
            <span class="pill">${escapeHtml(String(role))}</span>
          </div>
          <div>${linkify(escapeHtml(String(text)))}</div>
        `;
        messagesEl.appendChild(div);
      }
      activeSessionMetaEl.textContent = `${msgs.length} msgs`;
    }

    function escapeHtml(s) {
      return s
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function linkify(s) {
      const urlRe = /\bhttps?:\/\/[^\s<]+/g;
      return s.replace(urlRe, (u) => `<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`);
    }

    loadSessions();
  </script>
</body>
</html>
